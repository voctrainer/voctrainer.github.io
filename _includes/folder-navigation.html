<div class="folder-navigation">
    <h3 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 16px;">
        üìÅ –ù–∞–≤–∏–≥–∞—Ü–∏—è
    </h3>
    
    <div id="tree-navigation">
        <div style="color: #7f8c8d; font-style: italic; padding: 20px; text-align: center;">
            –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏...
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTreeNavigation();
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
async function loadTreeNavigation() {
    try {
        const currentPath = window.location.pathname.replace(/\/+/g, '/').replace(/\/$/, '');
        
        // –°—Ç—Ä–æ–∏–º –ø—É—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—è navigation.json —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏
        await renderPathNavigation(currentPath);
        
    } catch (error) {
        console.error('Error loading tree navigation:', error);
        document.getElementById('tree-navigation').innerHTML = 
            '<div style="color: #e74c3c; font-style: italic; padding: 20px; text-align: center; border: 1px solid #e74c3c; border-radius: 5px; background: #fdf2f2; font-size: 13px;">' +
            '‚ùå –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞' +
            '</div>';
    }
}

async function renderPathNavigation(currentPath) {
    // –ü–æ–ª—É—á–∞–µ–º navigation.json –¥–ª—è —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏
    const navData = await loadNavigationData(currentPath);
    
    if (!navData) {
        document.getElementById('tree-navigation').innerHTML = 
            '<div style="color: #7f8c8d; font-style: italic; padding: 20px; text-align: center; font-size: 13px;">–ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>';
        return;
    }
    
    let html = '<div class="tree-view" style="font-size: 13px; line-height: 1.4;">';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É "–ü–∞—Ä—Ç–∏—Ç—É—Ä—ã"
    html += `
        <div style="display: flex; align-items: center; margin: 1px 0;">
            <span style="font-family: monospace; color: #7f8c8d; margin-right: 8px;">‚îú‚îÄ</span>
            <a href="/partitures/" 
               style="color: #e67e22; font-weight: bold; text-decoration: none; display: flex; align-items: center; gap: 6px; padding: 3px 8px; border-radius: 3px; flex: 1; border: 1px solid transparent; transition: all 0.2s;"
               onmouseover="this.style.backgroundColor='#fff3e0'; this.style.borderColor='#e67e22';"
               onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='transparent';">
                üìÅ –ü–∞—Ä—Ç–∏—Ç—É—Ä—ã
            </a>
        </div>
    `;
    
    // –°—Ç—Ä–æ–∏–º –ø—É—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ currentPath
    const pathSegments = currentPath.split('/').filter(segment => segment && segment !== 'partitures');
    let accumulatedPath = '/partitures';
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—É—Ç—å –ø–∞–ø–æ–∫
    for (let i = 0; i < pathSegments.length; i++) {
        const segment = pathSegments[i];
        const isLastSegment = i === pathSegments.length - 1;
        accumulatedPath += '/' + segment;
        
        // –ü–æ–ª—É—á–∞–µ–º displayName –¥–ª—è —ç—Ç–æ–π –ø–∞–ø–∫–∏
        const segmentDisplayName = await getFolderDisplayName(accumulatedPath, segment);
        
        const indent = '  '.repeat(i + 1);
        const connector = isLastSegment ? '‚îî‚îÄ' : '‚îú‚îÄ';
        
        html += `
            <div style="display: flex; align-items: center; margin: 1px 0;">
                <span style="font-family: monospace; color: #7f8c8d; margin-right: 8px;">${indent}${connector}</span>
                <a href="${accumulatedPath}/" 
                   style="color: #e67e22; font-weight: bold; text-decoration: none; display: flex; align-items: center; gap: 6px; padding: 3px 8px; border-radius: 3px; flex: 1; border: 1px solid transparent; transition: all 0.2s;"
                   onmouseover="this.style.backgroundColor='#fff3e0'; this.style.borderColor='#e67e22';"
                   onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='transparent';">
                    ${isLastSegment ? 'üìÇ' : 'üìÅ'} ${segmentDisplayName}
                </a>
            </div>
        `;
        
        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏
        if (isLastSegment) {
            // –ü–∞–ø–∫–∏
            if (navData.folders && navData.folders.length > 0) {
                navData.folders.forEach((folder, folderIndex) => {
                    const isLastFolder = folderIndex === navData.folders.length - 1 && (!navData.files || navData.files.length === 0);
                    const indent = '  '.repeat(i + 2);
                    const connector = isLastFolder ? '‚îî‚îÄ' : '‚îú‚îÄ';
                    
                    html += `
                        <div style="display: flex; align-items: center; margin: 1px 0;">
                            <span style="font-family: monospace; color: #7f8c8d; margin-right: 8px;">${indent}${connector}</span>
                            <a href="${folder.path}${!folder.path.endsWith('/') ? '/' : ''}" 
                               style="color: #e67e22; font-weight: bold; text-decoration: none; display: flex; align-items: center; gap: 6px; padding: 3px 8px; border-radius: 3px; flex: 1; border: 1px solid transparent; transition: all 0.2s;"
                               onmouseover="this.style.backgroundColor='#fff3e0'; this.style.borderColor='#e67e22';"
                               onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='transparent';">
                                üìÅ ${folder.displayName}
                            </a>
                        </div>
                    `;
                });
            }
            
            // –§–∞–π–ª—ã
            if (navData.files && navData.files.length > 0) {
                navData.files.forEach((file, fileIndex) => {
                    const isLastFile = fileIndex === navData.files.length - 1;
                    const isCurrentFile = currentPath === file.path;
                    const indent = '  '.repeat(i + 2);
                    const connector = isLastFile ? '‚îî‚îÄ' : '‚îú‚îÄ';
                    const activeStyle = isCurrentFile ? 'background-color: #4051b5!important; color: white!important;' : '';
                    
                    html += `
                        <div style="display: flex; align-items: center; margin: 1px 0;">
                            <span style="font-family: monospace; color: #7f8c8d; margin-right: 8px;">${indent}${connector}</span>
                            <a href="${file.path}" 
                               style="color: #2c3e50; text-decoration: none; display: flex; align-items: center; gap: 6px; padding: 3px 8px; border-radius: 3px; flex: 1; border: 1px solid transparent; transition: all 0.2s; ${activeStyle}"
                               onmouseover="this.style.backgroundColor='${isCurrentFile ? '#4051b5' : '#f8f9fa'}'; this.style.borderColor='#4051b5';"
                               onmouseout="this.style.backgroundColor='${isCurrentFile ? '#4051b5' : 'transparent'}'; this.style.borderColor='transparent';">
                                üìÑ ${file.displayName}
                            </a>
                        </div>
                    `;
                });
            }
        }
    }
    
    html += '</div>';
    document.getElementById('tree-navigation').innerHTML = html;
}

async function loadNavigationData(currentPath) {
    // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å navigation.json –∏–∑ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏
    const possiblePaths = [
        './navigation.json',
        currentPath + '/navigation.json',
        '/partitures/navigation.json'
    ];
    
    for (const path of possiblePaths) {
        try {
            const response = await fetch(path);
            if (response.ok) {
                return await response.json();
            }
        } catch (error) {
            continue;
        }
    }
    return null;
}

async function getFolderDisplayName(folderPath, fallbackName) {
    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å displayName –∏–∑ navigation.json –ø–∞–ø–∫–∏
    const possiblePaths = [
        folderPath + '/navigation.json',
        folderPath + '../navigation.json'
    ];
    
    for (const path of possiblePaths) {
        try {
            const response = await fetch(path);
            if (response.ok) {
                const navData = await response.json();
                if (navData.currentFolder && navData.currentFolder.displayName) {
                    return navData.currentFolder.displayName;
                }
            }
        } catch (error) {
            continue;
        }
    }
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallbackName (–ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥)
    return fallbackName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ - —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–ª–µ—à–∏
function fixNavigationLinks() {
    document.addEventListener('click', function(e) {
        const link = e.target.closest('#tree-navigation a');
        if (link) {
            e.preventDefault();
            let href = link.getAttribute('href').replace(/\/+/g, '/');
            // –£–±–∏—Ä–∞–µ–º —Å–ª–µ—à –≤ –∫–æ–Ω—Ü–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤
            if (href.endsWith('.html/')) {
                href = href.slice(0, -1);
            }
            window.location.href = href;
        }
    });
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫
fixNavigationLinks();
</script>