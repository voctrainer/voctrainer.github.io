<div class="folder-navigation">
    <h3 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 16px;">
        üìÅ –ù–∞–≤–∏–≥–∞—Ü–∏—è
    </h3>
    
    <div id="tree-navigation">
        <div style="color: #7f8c8d; font-style: italic; padding: 20px; text-align: center;">
            –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏...
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTreeNavigation();
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
async function loadTreeNavigation() {
    try {
        const currentPath = window.location.pathname.replace(/\/+/g, '/').replace(/\/$/, '');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω–æ–µ –¥–µ—Ä–µ–≤–æ
        const fullTreeResponse = await fetch('https://voctrainer.github.io/partitures/full-tree.json');
        if (!fullTreeResponse.ok) {
            throw new Error('Failed to load full tree');
        }
        const fullTree = await fullTreeResponse.json();
        
        // –°—Ç—Ä–æ–∏–º –ø—É—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        renderPathNavigation(fullTree, currentPath);
        
    } catch (error) {
        console.error('Error loading tree navigation:', error);
        document.getElementById('tree-navigation').innerHTML = 
            '<div style="color: #e74c3c; font-style: italic; padding: 20px; text-align: center; border: 1px solid #e74c3c; border-radius: 5px; background: #fdf2f2; font-size: 13px;">' +
            '‚ùå –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞' +
            '</div>';
    }
}

function renderPathNavigation(tree, currentPath) {
    // –ù–∞—Ö–æ–¥–∏–º –ø—É—Ç—å –∫ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ/—Ñ–∞–π–ª—É
    const pathParts = findPathInTree(tree, currentPath);
    
    if (!pathParts || pathParts.length === 0) {
        document.getElementById('tree-navigation').innerHTML = 
            '<div style="color: #7f8c8d; font-style: italic; padding: 20px; text-align: center; font-size: 13px;">–ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>';
        return;
    }
    
    let html = '<div class="tree-view" style="font-size: 13px; line-height: 1.4;">';
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—É—Ç—å –æ—Ç –∫–æ—Ä–Ω—è –¥–æ —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
    pathParts.forEach((item, index) => {
        const isLast = index === pathParts.length - 1;
        const isFolder = item.type === 'folder';
        const isCurrent = currentPath === item.path;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç—Å—Ç—É–ø
        const indent = '  '.repeat(index);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∏ —Å—Ç–∏–ª—å
        let icon = 'üìÑ';
        let style = 'color: #2c3e50;';
        
        if (isFolder) {
            icon = isLast ? 'üìÇ' : 'üìÅ';
            style = 'color: #e67e22; font-weight: bold;';
        }
        
        if (isCurrent) {
            style += ' background-color: #4051b5!important; color: white!important;';
        }
        
        // –î–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ –¥–µ–ª–∞–µ–º —Å—Å—ã–ª–∫—É
        if (isLast && !isFolder) {
            html += `
                <div style="display: flex; align-items: center; margin: 1px 0;">
                    <span style="font-family: monospace; color: #7f8c8d; margin-right: 8px;">${indent}${isLast ? '‚îî‚îÄ' : '‚îú‚îÄ'}</span>
                    <span style="${style} display: flex; align-items: center; gap: 6px; padding: 3px 8px; border-radius: 3px; flex: 1;">
                        ${icon} ${item.displayName}
                    </span>
                </div>
            `;
        } else {
            // –î–ª—è –ø–∞–ø–æ–∫ –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ - —Å—Å—ã–ª–∫–∏
            const href = isFolder ? item.path + '/' : item.path;
            html += `
                <div style="display: flex; align-items: center; margin: 1px 0;">
                    <span style="font-family: monospace; color: #7f8c8d; margin-right: 8px;">${indent}${isLast ? '‚îî‚îÄ' : '‚îú‚îÄ'}</span>
                    <a href="${href}" 
                       style="${style} text-decoration: none; display: flex; align-items: center; gap: 6px; padding: 3px 8px; border-radius: 3px; flex: 1; border: 1px solid transparent; transition: all 0.2s;"
                       onmouseover="this.style.backgroundColor='${isCurrent ? '#4051b5' : (isFolder ? '#fff3e0' : '#f8f9fa')}'; this.style.borderColor='${isFolder ? '#e67e22' : '#4051b5'};'"
                       onmouseout="this.style.backgroundColor='${isCurrent ? '#4051b5' : 'transparent'}'; this.style.borderColor='transparent';">
                        ${icon} ${item.displayName}
                    </a>
                </div>
            `;
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ –ø–∞–ø–∫–∞ –∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤ –ø—É—Ç–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        if (isFolder && isLast && item.children) {
            renderFolderContents(item.children, html, index + 1, currentPath);
        }
    });
    
    html += '</div>';
    document.getElementById('tree-navigation').innerHTML = html;
}

function renderFolderContents(children, html, level, currentPath) {
    children.forEach((item, index) => {
        const isLast = index === children.length - 1;
        const isFolder = item.type === 'folder';
        const isCurrent = currentPath === item.path;
        
        const indent = '  '.repeat(level);
        let icon = isFolder ? 'üìÅ' : 'üìÑ';
        let style = isFolder ? 'color: #e67e22; font-weight: bold;' : 'color: #2c3e50;';
        
        if (isCurrent) {
            style += ' background-color: #4051b5!important; color: white!important;';
        }
        
        const href = isFolder ? item.path + '/' : item.path;
        html += `
            <div style="display: flex; align-items: center; margin: 1px 0;">
                <span style="font-family: monospace; color: #7f8c8d; margin-right: 8px;">${indent}${isLast ? '‚îî‚îÄ' : '‚îú‚îÄ'}</span>
                <a href="${href}" 
                   style="${style} text-decoration: none; display: flex; align-items: center; gap: 6px; padding: 3px 8px; border-radius: 3px; flex: 1; border: 1px solid transparent; transition: all 0.2s;"
                   onmouseover="this.style.backgroundColor='${isCurrent ? '#4051b5' : (isFolder ? '#fff3e0' : '#f8f9fa')}'; this.style.borderColor='${isFolder ? '#e67e22' : '#4051b5'};'"
                   onmouseout="this.style.backgroundColor='${isCurrent ? '#4051b5' : 'transparent'}'; this.style.borderColor='transparent';">
                    ${icon} ${item.displayName}
                </a>
            </div>
        `;
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—É—Ç–∏ –≤ –¥–µ—Ä–µ–≤–µ
function findPathInTree(tree, targetPath) {
    function search(items, path) {
        for (const item of items) {
            const currentPath = path.concat([item]);
            
            if (item.path === targetPath) {
                return currentPath;
            }
            
            if (item.type === 'folder' && item.children) {
                const found = search(item.children, currentPath);
                if (found) return found;
            }
        }
        return null;
    }
    
    return search(tree, []);
}

// –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ - —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–ª–µ—à–∏
function fixNavigationLinks() {
    document.addEventListener('click', function(e) {
        if (e.target.closest('#tree-navigation a')) {
            e.preventDefault();
            const href = e.target.closest('a').getAttribute('href').replace(/\/+/g, '/').replace(/\/$/, '');
            window.location.href = href + (e.target.closest('a').getAttribute('href').endsWith('/') ? '/' : '');
        }
    });
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫
fixNavigationLinks();
</script>