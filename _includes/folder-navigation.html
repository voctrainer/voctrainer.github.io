<div class="folder-navigation">
    {% comment %} –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å {% endcomment %}
    {% if page.url != '/partitures/' %}
        <div class="parent-link">
            <a href="/partitures/" style="
                display: inline-flex;
                align-items: center;
                gap: 8px;
                color: #4051b5;
                text-decoration: none;
                font-weight: bold;
                margin-bottom: 20px;
                padding: 8px 12px;
                background: white;
                border-radius: 5px;
                border: 1px solid #e9ecef;
            ">
                ‚§¥Ô∏è –ù–∞–∑–∞–¥ –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            </a>
        </div>
    {% endif %}

    <h3 style="margin: 0 0 15px 0; color: #2c3e50;">
        {% if page.url == '/partitures/' %}
            üìÅ –í—Å–µ –ø–∞—Ä—Ç–∏—Ç—É—Ä—ã
        {% else %}
            üìÅ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
        {% endif %}
    </h3>

    {% comment %} –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ filelist.json {% endcomment %}
    <div id="dynamic-navigation">
        –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏...
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadNavigation();
});

async function loadNavigation() {
    try {
        const response = await fetch('/partitures/filelist.json');
        if (!response.ok) throw new Error('File not found');
        const fileList = await response.json();
        
        const currentPath = window.location.pathname;
        const navContainer = document.getElementById('dynamic-navigation');
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏
        const childItems = fileList.filter(item => {
            if (item.type === 'folder') {
                return item.path === currentPath;
            } else {
                const itemDir = item.path.split('/').slice(0, -1).join('/') + '/';
                return itemDir === currentPath;
            }
        });

        if (childItems.length === 0) {
            navContainer.innerHTML = '<div style="color: #7f8c8d; font-style: italic; padding: 20px; text-align: center;">–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞</div>';
            return;
        }

        let html = '<ul style="list-style: none; padding-left: 0; margin: 0;">';
        
        // –°–Ω–∞—á–∞–ª–∞ –ø–∞–ø–∫–∏
        childItems.filter(item => item.type === 'folder').forEach(item => {
            const displayName = formatDisplayName(item.name);
            html += `
                <li style="margin-bottom: 8px;">
                    <a href="${item.path}" style="
                        color: #e67e22;
                        text-decoration: none;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 8px 12px;
                        background: white;
                        border-radius: 5px;
                        border: 1px solid #e9ecef;
                        font-weight: bold;
                        transition: all 0.2s;
                    " onmouseover="this.style.backgroundColor='#fff3e0'; this.style.borderColor='#e67e22';"
                       onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#e9ecef';">
                        üìÅ ${displayName}
                    </a>
                </li>
            `;
        });
        
        // –ó–∞—Ç–µ–º —Ñ–∞–π–ª—ã - –∑–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
        const fileItems = childItems.filter(item => item.type === 'file');
        
        if (fileItems.length > 0) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
            const fileMetadata = await loadFileMetadata(fileItems);
            
            fileItems.forEach(item => {
                const metadata = fileMetadata[item.path] || {};
                const displayName = metadata.title || formatDisplayName(item.name);
                const composer = metadata.composer ? ` - ${metadata.composer}` : '';
                
                html += `
                    <li style="margin-bottom: 8px;">
                        <a href="${item.path}" style="
                            color: #2c3e50;
                            text-decoration: none;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 8px 12px;
                            background: white;
                            border-radius: 5px;
                            border: 1px solid #e9ecef;
                            transition: all 0.2s;
                        " onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.borderColor='#4051b5';"
                           onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#e9ecef';"
                           title="${composer ? '–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä: ' + metadata.composer : ''}">
                            üìÑ ${displayName}${composer}
                        </a>
                    </li>
                `;
            });
        }
        
        html += '</ul>';
        navContainer.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading navigation:', error);
        document.getElementById('dynamic-navigation').innerHTML = 
            '<div style="color: #e74c3c; font-style: italic; padding: 20px; text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏</div>';
    }
}

async function loadFileMetadata(fileItems) {
    const metadata = {};
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
    const promises = fileItems.map(async (item) => {
        try {
            const response = await fetch(item.path);
            if (!response.ok) return;
            
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // –ò—â–µ–º ABC –∫–æ–Ω—Ç–µ–Ω—Ç
            const abcSource = doc.querySelector('.abc-source');
            if (abcSource) {
                const abcContent = abcSource.textContent;
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ ABC
                const titleMatch = abcContent.match(/T:\s*([^\n]+)/);
                const composerMatch = abcContent.match(/C:\s*([^\n]+)/);
                
                metadata[item.path] = {
                    title: titleMatch ? titleMatch[1].trim() : null,
                    composer: composerMatch ? composerMatch[1].trim() : null
                };
            }
        } catch (error) {
            console.error('Error loading metadata for', item.path, error);
        }
    });
    
    await Promise.all(promises);
    return metadata;
}

function formatDisplayName(name) {
    return name
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ')
        .replace(/([a-z])([A-Z])/g, '$1 $2') // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏
        .replace(/^Partitures$/, '–ö–æ–ª–ª–µ–∫—Ü–∏—è –ø–∞—Ä—Ç–∏—Ç—É—Ä')
        .replace(/^Cherubic$/i, '–•–µ—Ä—É–≤–∏–º—Å–∫–∏–µ');
}
</script>
