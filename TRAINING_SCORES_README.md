# Генерация учебных партитур

## Описание функциональности

Система автоматически генерирует учебные варианты партитур с возможностью постепенного изучения по частям.

## Типы разбиения

### 1. По строкам
Партитура делится на строки, где каждая строка содержит полный набор голосов (от [V:1] до следующего [V:1]).

**Пример структуры строки:**
```abc
[V:1]GGGB BBBB A2AB2 | BBB GGG ^F2FG2 || %1
[V:2]DDD GGGGG F2FF2 | FFFEEED2DD2 || %1
w:Бла-го-сло-ви, ду-ше мо-я, Го-спо-да...
[V:3]bbbe'e'e'e'e'c'2c'd'2 |d'd'd'bbc'a2ab2 || %1
[V:4]gggcccccf2fB2 | BBBeecd2dg2 || %1
```

### 2. По разделам (%%text)
Партитура делится по директивам `%%text`, которые обозначают смысловые разделы произведения.

**Пример:**
```abc
[V:1]GABBBBA/B/cB(B/A/B)|
[V:2]GGGGGGGGGG2|
w:Дос-той-но есть, я-ко во-ис-тин-ну,
[V:3]Bcddddc/d/ed(d/c/d)|
[V:4]gggggggc/e/g(g>=f)|
%%text 2
[V:1]cB c/d/ d/c/ Bc/d/ d/c/ B/A/B2|
...
```

## Условия генерации

Учебная партитура генерируется, если:

1. **Глобальная настройка включена** (`GENERATE_TRAINING_SCORES = true` в `convert-abc.js`)
2. **Есть разбиение по строкам** - первый голос встречается более одного раза в партитуре

Учебная партитура **НЕ генерируется**, если:
- Все голоса записаны одной непрерывной строкой без разбиения
- Глобальная настройка отключена

## Структура учебного HTML

Для партитур с учебным вариантом генерируются вкладки:

1. **"Полная партитура"** - исходная партитура целиком
2. **"По строкам"** - разбиение по строкам (всегда доступно)
3. **"По разделам"** - разбиение по %%text (если есть директивы %%text)

### Примеры партитур

**С учебным вариантом:**
- `abc/liturgy/liturgy_of_the_catechumens/antiphons/antifony_tumarkin.abc`
- `abc/special_services/episcopal_worship/dostoino_at_the_episcopal_service.abc`

**Без учебного варианта (непрерывная запись):**
- `abc/liturgy/liturgy_of_the_faithful/mercy_of_peace/milost_mira_arhangelskogo.abc`
- `abc/liturgy/liturgy_of_the_faithful/mercy_of_peace/milost_mira_bogdanov.abc`

## Управление настройками

### Глобальное отключение/включение

В файле `convert-abc.js` измените константу:

```javascript
// Глобальная настройка для генерации учебных партитур
const GENERATE_TRAINING_SCORES = true;  // false - отключить
```

После изменения запустите:
```powershell
node convert-abc.js
```

## Технические детали

### Структура заголовка

- **Первый раздел** - полный заголовок с Title (T:) и Composer (C:)
- **Последующие разделы** - заголовок без Title и Composer

### Особенности интерфейса

- Вкладки автоматически переключаются при клике
- ABC UI переинициализируется при смене вкладки
- Каждый раздел имеет отдельную кнопку воспроизведения
- Стили вкладок интегрированы с основной темой сайта

## Примеры использования

### Антифоны Тумаркина
Партитура разделена на 19 строк для постепенного разучивания.

### Достойно есть (архиерейское)
Партитура имеет разбиение и по строкам (8 разделов), и по %%text (8 смысловых частей).

## Отладка

Для проверки работы генератора:

1. Запустите генерацию:
   ```powershell
   node convert-abc.js
   ```

2. Откройте сгенерированный HTML файл в браузере

3. Проверьте наличие вкладок в партитурах с разбиением по строкам

## Дополнительная информация

- Маркеры %1, %2 и т.д. в конце строк используются для нумерации, но не обязательны
- Система автоматически определяет первый голос по минимальному номеру
- Пустые строки и комментарии игнорируются при разбиении
